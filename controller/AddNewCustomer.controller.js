sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/json/JSONModel","sap/ui/model/Context","sap/ui/model/FilterOperator","sap/m/UploadCollectionParameter"],function(e,t,a,o,n,s,i){"use strict";return e.extend("MDG.Customer.controller.AddNewCustomer",{onInit:function(){var e=this;this.oBundle=this.getOwnerComponent().getModel("i18n").getResourceBundle();this.getOwnerComponent().getRouter().getRoute("AddNewCustomer").attachPatternMatched(this.onObjectMatched,this);this.oDoc={fileName:"",mediaType:"",url:"",keyword:"",shortDescription:""};e.handleCustomerType();e.addCustomerProjects();e.handleCustomerContactType()},handleCustomerType:function(){var e=this;var t="3";$.ajax({url:"/DanaoStrapi/api/d-sales-user-types?populate=*&filters[id][$eq]="+t,type:"GET",headers:{"content-type":"application/json"},dataType:"json",success:function(t){var a=t.data[0].attributes.d_customer_types.data;var o=[];for(var n=0;n<a.length;n++){a[n].attributes.id=a[n].id;o.push(a[n].attributes)}e.getView().setModel(new sap.ui.model.json.JSONModel(o),"customerTypeModel")}})},onObjectMatched:function(e){var t=this;var a=e.getParameter("arguments").AddCust;t.isAdd=a;if(a!=="Edit"){t.mode="Create";var n="CUST"+(this.getView().getModel("appView").getData().lastId+1);t.newcustomer={id:n,customerName:"",email:"",contact:"",contactPerson:"",contactEmail:"",contactPhone:"",contactDesignation:"",country:"",city:"",address:"",description:"",zipCode:"",documents:[]};t.getView().setModel(new o(t.newcustomer))}else{t.mode="Edit";t.path=t.getView().getModel("appView").oData.indexNo;var s=t.getOwnerComponent().getModel("customerInfo");var i=new sap.ui.model.Context(s,"/"+t.path);t.newcustomer=i.getObject();t.customerId=i.getObject().id;t.getView().setModel(new o(t.newcustomer));t.getView().getModel().updateBindings(true)}},___handleAddUserOkPress:function(){this.getOwnerComponent().getModel("customerInfo").getData().push(this.newcustomer);this.getOwnerComponent().getModel("customerInfo").updateBindings(true);this.getView().getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",false);this.getOwnerComponent().getRouter().navTo("Master");this.getView().getModel("appView").getData().lastId=this.getView().getModel("appView").getData().lastId+1},handleAddUserOkPress:function(e){var t=this;var o={data:{dCustomerName:this.getView().byId("custName").getValue(),dWebsite:this.getView().byId("website").getValue(),dOfficePhone:this.getView().byId("abtCust").getValue(),dBillingAddress:this.getView().byId("addr").getValue(),d_customer_type:[this.getView().byId("custType").getSelectedKey()]}};var n;var s;if(t.mode=="Create"){n="/DanaoStrapi/api/d-customers";s="POST"}else{n="/DanaoStrapi/api/d-customers/"+t.customerId;s="PUT"}$.ajax({url:n,type:s,headers:{"content-type":"application/json"},data:JSON.stringify(o),dataType:"json",success:function(e){t.addCustomerContacts(o,e.data.id)},error:function(e){a.error(e.responseJSON.error.message)}})},handleWizardCancel:function(){this.getView().getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",false);this.getOwnerComponent().getRouter().navTo("Master");this.getView().getModel("appView").setProperty("/layout","OneColumn")},handleCustomerContactType:function(){var e=this;$.ajax({url:"/DanaoStrapi/api/d-customer-contact-types",type:"GET",headers:{"content-type":"application/json"},dataType:"json",success:function(t){var a=t.data;var o=[];for(var n=0;n<a.length;n++){o.push({id:a[n].id,DCustomerContact_type:a[n].attributes.DCustomerContact_type})}console.log(o);e.getView().setModel(new sap.ui.model.json.JSONModel(o),"CustomerContactModel")}})},addCustomerContacts:function(e,t){var a=this;var e={data:{dCustomerContact_Name:a.getView().byId("cname").getValue(),dCustomer_ContactEmail:a.getView().byId("ceml").getValue(),dCustomer_Conact_DirectPhone:a.getView().byId("crty").getValue(),dCustomer_ContactMobile:a.getView().byId("contNum").getValue(),d_customer_contact_type:[a.getView().byId("conctType").getSelectedKey()]}};$.ajax({url:"/DanaoStrapi/api/d-customer-contacts",type:"POST",headers:{"content-type":"application/json"},data:JSON.stringify(e),dataType:"json",success:function(e){a.updateCustomerContacts(e.data.id,t);a.getView().getModel("appView").setProperty("/layout","OneColumn");a.getView().getModel("appView").setProperty("/indexNo",this.index)},error:function(){sap.m.MessageBox.error("Contact Data has not Added")}})},updateCustomerContacts:function(e,t){var o=this;var n={data:{d_customer_contacts:[e]}};$.ajax({url:"/DanaoStrapi/api/d-customers/"+t,type:"PUT",headers:{"content-type":"application/json"},data:JSON.stringify(n),dataType:"json",success:function(e){a.success("Customer has been added successfully");o.getView().getModel("appView").setProperty("/layout","OneColumn");o.getView().getModel("appView").setProperty("/indexNo",this.index);var t=o.getOwnerComponent().getRouter();t.navTo("Master",{id:"0"})}})},addCustomerProjects:function(e){var t=this;var o={data:{dCustomer_TypeCode:this.getView().byId("custType").getValue()}};$.ajax({url:"/DanaoStrapi/api/d-customers",type:"POST",headers:{"content-type":"application/json"},data:JSON.stringify(o),dataType:"json",success:function(o){t.index=e.getSource().getSelectedContextPaths()[0].split("")[1];var n=e.getSource().getSelectedItem().getBindingContext("customerTypeModel").getObject().id;t.getView().getModel("appView").setProperty("/indexNo",this.index);a.success("Customer has been added successfully");var s=this.getView().getModel("appView").getProperty("/actionButtonsInfo/midColumn/closeColumn");t.getView().getModel("appView").setProperty("/actionButtonsInfo/midColumn/closeColumn");t.getView().getModel("appView").setProperty("/layout","OneColumn");t.getOwnerComponent().getRouter().navTo("Detail",{id:n,moduleIndex:this.index})}})},handleDocumentUpload:function(){if(!this.AddDocumentFragment){this.AddDocumentFragment=sap.ui.xmlfragment("MDG.Customer.fragment.customerDocument",this);this.getView().addDependent(this.AddDocumentFragment)}this.AddDocumentFragment.open()},collectFileData:function(e){var t=e.getParameter("files")[0];this.fileData={fileName:t.name,mediaType:t.type,url:"",keyword:"",shortDescription:""}},handleAddDocumentOkPress:function(){this.fileData.keyword=this.AddDocumentFragment.getContent()[0].getContent()[1].getValue();this.fileData.shortDescription=this.AddDocumentFragment.getContent()[0].getContent()[2].getValue();this.getView().getModel().getData().documents.push(this.fileData);this.getView().getModel().updateBindings(true);this.handleAddUserCancelPress();t.show("Document added succesfuly.")},handleAddUserCancelPress:function(){this.AddDocumentFragment.close();this.clear()},clear:function(){this.fileData.keyword=this.AddDocumentFragment.getContent()[0].getContent()[1].setValue("");this.fileData.shortDescription=this.AddDocumentFragment.getContent()[0].getContent()[2].setValue("")},ValidateCreateCust:function(){var e=0;if(this.getView().byId("custName").getValue()==""||this.getView().byId("custName").getValue()===null){e++}else{this.getView().byId("custName").setValueState("None")}if(this.getView().byId("eml").getValue()==""||this.getView().byId("eml").getValue()===null){e++}else{this.getView().byId("eml").setValueState("None")}if(this.getView().byId("contNum").getValue()==""||this.getView().byId("contNum").getValue()===null){e++}else{this.getView().byId("contNum").setValueState("None")}if(this.getView().byId("abtCust").getValue()==""||this.getView().byId("abtCust").getValue()===null){e++}else{this.getView().byId("abtCust").setValueState("None")}if(this.getView().byId("addr").getValue()==""||this.getView().byId("addr").getValue()===null){e++}else{this.getView().byId("addr").setValueState("None")}if(this.getView().byId("cty").getValue()==""||this.getView().byId("cty").getValue()===null){e++}else{this.getView().byId("cty").setValueState("None")}if(this.getView().byId("crty").getValue()==""||this.getView().byId("cty").getValue()===null){e++}else{this.getView().byId("crty").setValueState("None")}return e},selectDocumentType:function(e){var a=this;var o=new sap.m.Panel;var n=new sap.m.HBox;n.addStyleClass("sapUiTinyMarginTop");var s=new sap.m.VBox;var i=new sap.m.Text({text:""});var r=new sap.ui.core.Item({key:"{Key}",text:"{Key}{Seperator}{Text}{Mandatory}",tooltip:"{Key}{Seperator}{Text}"});var d=new sap.m.UploadCollection({fileType:["jpg","png","jpeg","bmp"],maximumFilenameLength:55,maximumFileSize:1,multiple:false,sameFilenameAllowed:false,instantUpload:false,showSeparators:"All",noDataText:"No Data Found",change:function(e){a.onChange(e)},fileDeleted:function(e){a.onFileDeleted(e)},filenameLengthExceed:function(e){a.onFilenameLengthExceed(e)},fileSizeExceed:function(e){a.onFileSizeExceed(e)},typeMissmatch:function(e){a.onTypeMissmatch(e)},beforeUploadStarts:function(e){a.onBeforeUploadStarts(e)},uploadComplete:function(e){a.onUploadComplete(e)},uploadUrl:""});s.addItem(d);s.addStyleClass("sapUiTinyMargin");o.addContent(s);this.dialog=new sap.m.Dialog({title:"My Document",type:"Standard",resizable:true,contentWidth:"50%",contentHeight:"50%",state:"None",icon:"sap-icon://attachment",draggable:true,content:o,buttons:[new sap.m.Button({text:"Upload",press:function(){this.getView().byId("UploadSet").getModel().getData().documents.push(this.fileData);this.getView().byId("UploadSet").getModel().updateBindings(true);this.getView().getModel().getData().documents.push(this.fileData);this.getView().getModel().updateBindings(true);this.handleAddUserCancelPress();t.show("Document added succesfuly.")}}),new sap.m.Button({text:"Cancel",press:function(){a.dialog.close()}})],afterClose:function(){}});var l=this.dialog;a.dialog.open();if(sap.ui.Device.support.touch===false){a.dialog.addStyleClass("sapUiSizeCompact")}},onFileSizeExceed:function(e){sap.m.MessageToast.show("Please select less than 1 mb file");if(this.onFileSizeExceed_Exit){this.onFileSizeExceed_Exit()}},onTypeMissmatch:function(e){sap.m.MessageToast.show("Please Select Images");if(this.onTypeMissmatch_Exit){this.onTypeMissmatch_Exit()}},onChange:function(e){var t=e.getParameter("files")[0];this.fileData={fileName:t.name,mediaType:t.type,url:""}},onFileDeleted:function(e){gGRAttachments.setBusy(true);oPPCCommon.removeAllMsgs();var t=this;var a;var o=this._oComponent.getModel("SSGW_MM");var n=this.getCurrentUsers("MaterialDocDocuments","delete");o.setHeaders({"x-arteria-loginid":n});var s=this._oComponent.getModel("SSGW_MM").getSecurityToken();o.setHeaders({"x-csrf-token":s});SchemeGUID=this._oComponent.getModel("LocalViewSetting").getProperty("/GRDocGuid").toUpperCase();var i="guid'"+SchemeGUID+"'";a="MaterialDocDocuments(MaterialDocGUID="+i+",MatDocDocumentGUID='"+escape(e.getParameters().documentId)+"',DocumentStore='"+DocumentStore+"')";o.remove("/"+a,{headers:{"x-arteria-loginid":n},success:function(){oPPCCommon.removeDuplicateMsgsInMsgMgr();var e=oPPCCommon.getMsgsFromMsgMgr();vIndex++;t.getContractDocumentss(t._oComponent,oi18n.getText("ContractAttachments.message.deleted"))},error:function(e){gGRAttachments.setBusy(false);oPPCCommon.removeDuplicateMsgsInMsgMgr();var a=oPPCCommon.getMsgsFromMsgMgr();oPPCCommon.displayMsg_MsgBox(t.getView(),a,"error");oDialog.close()}})},onFilenameLengthExceed:function(e){if(e.mParameters.mParameters.fileName.length>55){var t=oi18n.getText("File name Length Exceeded");oPPCCommon.displayMsg_MsgBox(this.getView(),t,"error")}if(this.onFilenameLengthExceed_Exit){this.onFilenameLengthExceed_Exit()}},onBeforeUploadStarts:function(e){var t=this.getCurrentUsers("MaterialDocDocuments","write");var a=new sap.m.UploadCollectionParameter({name:"x-arteria-loginid",value:t});var o;var n=new sap.m.UploadCollectionParameter({name:"helo",value:token});var s=this._oComponent.getModel("LocalViewSetting").getProperty("/DocType");vIndex++;var i=e.mParameters.fileName;SchemeGUID=this._oComponent.getModel("LocalViewSetting").getProperty("/GRDocGuid").toUpperCase();SchemeGUID=SchemeGUID.split("-").join("");var r=oPPCCommon.generateUUID().toUpperCase();r=r.split("-").join("");o=new sap.m.UploadCollectionParameter({name:"SLUG",value:"MaterialDocGUID:"+SchemeGUID+",DocumentStore:"+DocumentStore+",MatDocDocumentGUID:"+r+",DocumentTypeID:"+s+",FileName:"+i+",LoginID:"+t});e.getParameters().addHeaderParameter(n);e.getParameters().addHeaderParameter(a);e.getParameters().addHeaderParameter(o)},onUploadComplete:function(e){if(e.getParameter("files")[0].status===201){this.getContractDocumentss(this._oComponent,oi18n.getText("ContractAttachments.message.uploaded"))}else{var t="";var a=e.getParameter("files")[0].responseRaw}}})});