sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/ui/model/json/JSONModel"],function(e,t,a){"use strict";return e.extend("MDG.Help.controller.addNewProject",{onInit:function(){var e=this;sap.ui.core.UIComponent.getRouterFor(this).getRoute("addNewProject").attachPatternMatched(this.handlePatternMatched,this)},handlePatternMatched:function(e){this.customerId=e.getParameter("arguments").AddPro;this.mode=e.getParameter("arguments").mode;this.projectId=e.getParameter("arguments").projectId;this.getView().byId("wizardId").setShowNextButton(true);this.handleContactName();this.handleProjectType();this.handleProjectCategory();this.handleSalesStage();if(this.mode==="Edit"){this.handleEdit()}},handleEdit:function(){var e=this;var t=e.projectId;$.ajax({url:"/DanaoStrapi/api/d-customer-projects?populate=*&filters[id][$eq]="+t,type:"GET",headers:{"content-type":"application/json"},dataType:"json",success:function(t){var o=t.data;var d=t.data[0].attributes;e.newProject={dCustomer_ProjectName:d.dCustomer_ProjectName,dProject_CompletionDateAtD:d.dProject_CompletionDate,dProject_Add_Notes:d.dProject_Add_Notes,dProject_Probability:d.dProject_Probability,dProject_Expected_CloseDate:d.dProject_Expected_CloseDate,dProject_ExpectedStartDate:d.dProject_ExpectedStartDate,dProject_Shipto_ldDock:d.dProject_Shipto_ldDock,DProject_Sales_Stage:d.d_project_sales_stage.data.attributes.DProject_Sales_Stage,DProject_Type:d.d_project_type.data==null?"":d.d_project_type.data.attributes.DProject_Type,DProject_Category:d.d_project_category.data==null?"":d.d_project_category.data.attributes.DProject_Category,DProject_TypeId:d.d_project_type.data.id,DProject_CategoryId:d.d_project_category.data.id,DProject_Sales_StageId:d.d_project_sales_stage.data.id};e.getView().setModel(new a(e.newProject));e.getView().getModel().updateBindings(true)}})},handleAddProjectPress:function(){var e=this;var a=this.customerId;var o=this.projectId;var d=this.mode;if(d==="Edit"){var r={data:{dCustomer_ProjectName:this.getView().byId("proName").getValue(),dProject_ExpectedStartDate:this.getView().byId("startDate").getValue(),dProject_Expected_CloseDate:this.getView().byId("closeDate").getValue(),dProject_CompletionDate:this.getView().byId("cDate").getValue(),dProject_Add_Notes:this.getView().byId("ProNotes").getValue(),dProject_Probability:this.getView().byId("Probability").getValue(),dProject_Shipto_ldDock:this.getView().byId("ld_dock_true").getSelected(),d_customer_contacts:[this.getView().byId("contName").getSelectedKey()],d_project_type:[this.getView().byId("proTypeName").getSelectedKey()],d_project_category:[this.getView().byId("catgoryName").getSelectedKey()],d_project_sales_stage:[this.getView().byId("salesName").getSelectedKey()]}};$.ajax({url:"/DanaoStrapi/api/d-customer-projects/"+o,type:"PUT",headers:{"content-type":"application/json"},data:JSON.stringify(r),dataType:"json",success:function(t){e.mode="";e.getView().getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",false);e.getOwnerComponent().getRouter().navTo("Detail",{id:e.getView().getModel("appView").oData.RequestIdSelected,moduleIndex:e.getView().getModel("appView").oData.moduleIndexForDetail,newprojectId:e.projectId})}})}else{var r={data:{dCustomer_ProjectName:this.getView().byId("proName").getValue(),dProject_ExpectedStartDate:this.getView().byId("startDate").getValue(),dProject_Expected_CloseDate:this.getView().byId("closeDate").getValue(),dProject_CompletionDate:this.getView().byId("cDate").getValue(),dProject_Add_Notes:this.getView().byId("ProNotes").getValue(),dProject_Probability:this.getView().byId("Probability").getValue(),dProject_Shipto_ldDock:this.getView().byId("ld_dock_true").getSelected(),d_customer_contacts:[e.selectedIdOfContact],d_project_type:[this.getView().byId("proTypeName").getSelectedKey()],d_project_category:[this.getView().byId("catgoryName").getSelectedKey()],d_project_sales_stage:[this.getView().byId("salesName").getSelectedKey()]}};$.ajax({url:"/DanaoStrapi/api/d-customer-projects",type:"POST",headers:{"content-type":"application/json"},data:JSON.stringify(r),dataType:"json",success:function(o){e.getView().getModel("appView").oData.CustomerProjectForIds.push({id:o.data.id});e.handleAddProjectToCustomer(o.data.id,a);t.success("Project has beeen Created");e.getView().getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",false);e.getOwnerComponent().getRouter().navTo("Detail",{id:e.getView().getModel("appView").oData.RequestIdSelected,moduleIndex:e.getView().getModel("appView").oData.moduleIndexForDetail,newprojectId:"newprojectId"})},error:function(e){t.error(e.responseJSON.error.message)}})}},handleAddProjectToCustomer:function(e,t){var a=this;var o=a.getView().getModel("appView").oData.CustomerProjectIds;o.push(e);var d={data:{d_customer_projects:o}};$.ajax({url:"/DanaoStrapi/api/d-customers/"+t,type:"PUT",headers:{"content-type":"application/json"},data:JSON.stringify(d),dataType:"json",success:function(e){}})},handleProjectType:function(){var e=this;$.ajax({url:"/DanaoStrapi/api/d-project-types?populate=*",type:"GET",headers:{"content-type":"application/json"},dataType:"json",success:function(t){var a=t.data;var o=[];for(var d=0;d<a.length;d++){a[d].attributes.id=a[d].id;o.push(a[d].attributes)}e.getView().setModel(new sap.ui.model.json.JSONModel(o),"ProjectTypeModel");if(e.mode==="Edit"){var r=e.getView().getModel().getData().DProject_TypeId;e.getView().byId("proTypeName").setSelectedKey(r.toString())}}})},handleSalesStage:function(){var e=this;$.ajax({url:"/DanaoStrapi/api/d-project-sales-stages?populate=*",type:"GET",headers:{"content-type":"application/json"},dataType:"json",success:function(t){var a=t.data;var o=[];for(var d=0;d<a.length;d++){a[d].attributes.id=a[d].id;o.push(a[d].attributes)}e.getView().setModel(new sap.ui.model.json.JSONModel(o),"ProjectModel");if(e.mode==="Edit"){var r=e.getView().getModel().getData().DProject_Sales_StageId;e.getView().byId("salesName").setSelectedKey(r.toString())}}})},handleProjectCategory:function(){var e=this;$.ajax({url:"/DanaoStrapi/api/d-project-categories?populate=*",type:"GET",headers:{"content-type":"application/json"},dataType:"json",success:function(t){var a=t.data;var o=[];for(var d=0;d<a.length;d++){a[d].attributes.id=a[d].id;o.push(a[d].attributes)}e.getView().setModel(new sap.ui.model.json.JSONModel(o),"ProjectCategoryModel");if(e.mode==="Edit"){var r=e.getView().getModel().getData().DProject_CategoryId;e.getView().byId("catgoryName").setSelectedKey(r.toString())}}})},handleContactName:function(){var e=this;$.ajax({url:"/DanaoStrapi/api/d-customers?populate=*&filters[id][$eq]="+this.customerId,type:"GET",headers:{"content-type":"application/json"},dataType:"json",success:function(t){var a=t.data[0].attributes.d_customer_contacts.data;var o=[];for(var d=0;d<a.length;d++){a[d].attributes.id=a[d].id;o.push(a[d].attributes)}$.ajax({url:"/DanaoStrapi/api/d-customer-contacts?populate=*&pagination[pageSize]=200",type:"GET",headers:{"content-type":"application/json"},dataType:"json",success:function(t){var d=t.data;var r=[];for(var i=0;i<o.length;i++){for(var s=0;s<d.length;s++){if(d[s].id===o[i].id){if(d[s].attributes.d_customer_contact_type.data.attributes.DCustomerContact_type==="Main Contact"){r.push(d[s])}}}}var c=[];for(var n=0;n<r.length;n++){c.push(a[n].attributes);c[n].id=r[n].id}e.getView().setModel(new sap.ui.model.json.JSONModel(c),"contactNameModel");e.getView().byId("contName").setValue(c[0].dCustomerContact_Name);e.getView().byId("ceml").setValue(c[0].dCustomer_ContactEmail);e.getView().byId("crty").setValue(c[0].dCustomer_Conact_DirectPhone);e.getView().byId("contNum").setValue(c[0].dCustomer_ContactMobile);e.selectedIdOfContact=c[0].id}})}})},handleProjectCancel:function(e){this.getView().byId("proName").setValue("");this.getView().byId("proTypeName").setValue("");this.getView().byId("catgoryName").setValue("");this.getView().byId("salesName").setValue("");this.getView().byId("startDate").setValue("");this.getView().byId("closeDate").setValue("");this.getView().byId("cDate").setValue("");this.getView().byId("ProNotes").setValue("");this.getView().byId("Probability").setValue("");this.getView().getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",false);this.getOwnerComponent().getRouter().navTo("Detail",{id:this.getView().getModel("appView").oData.RequestIdSelected,moduleIndex:this.getView().getModel("appView").oData.moduleIndexForDetail,newprojectId:this.projectId})},handleSelectContact:function(e){}})});